<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#06030f"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="åŒé¢‘"/>
  <link rel="manifest" href="manifest.json"/>
  <title>åŒé¢‘ Â· ä»Šæ—¥ä¹‹å£°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600&family=ZCOOL+XiaoWei&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #06030f;
      --bg2: #0d0820;
      --bg3: #130c2a;
      --s1: rgba(255,255,255,0.04);
      --s2: rgba(255,255,255,0.07);
      --s3: rgba(255,255,255,0.12);
      --b1: rgba(255,255,255,0.07);
      --b2: rgba(255,255,255,0.13);
      --b3: rgba(255,255,255,0.22);
      --v: #7c3aed;
      --vs: #a78bfa;
      --vl: #c4b5fd;
      --r: #e11d48;
      --rs: #fb7185;
      --rl: #fda4af;
      --g: #059669;
      --gs: #34d399;
      --a: #d97706;
      --as: #fbbf24;
      --sky: #0ea5e9;
      --t1: #f5f0ff;
      --t2: rgba(245,240,255,0.6);
      --t3: rgba(245,240,255,0.3);
      --t4: rgba(245,240,255,0.12);
      --rad: 20px;
      --rads: 13px;
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{scroll-behavior:smooth}

    body {
      background: var(--bg);
      color: var(--t1);
      font-family: 'Noto Serif SC', serif;
      min-height: 100dvh;
      max-width: 430px;
      margin: 0 auto;
      overflow-x: hidden;
      position: relative;
    }

    /* Grain texture overlay */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0; opacity: 0.4;
    }

    /* Ambient glows */
    .glow {
      position: fixed; pointer-events: none; z-index: 0;
      border-radius: 50%; filter: blur(80px);
    }
    .glow-1 {
      width: 400px; height: 400px;
      top: -100px; left: -80px;
      background: radial-gradient(circle, rgba(124,58,237,0.15), transparent 70%);
      animation: floatA 14s ease-in-out infinite alternate;
    }
    .glow-2 {
      width: 350px; height: 350px;
      bottom: 100px; right: -60px;
      background: radial-gradient(circle, rgba(225,29,72,0.1), transparent 70%);
      animation: floatB 18s ease-in-out infinite alternate;
    }
    .glow-3 {
      width: 300px; height: 300px;
      top: 50%; left: 30%;
      background: radial-gradient(circle, rgba(14,165,233,0.06), transparent 70%);
      animation: floatC 22s ease-in-out infinite alternate;
    }
    @keyframes floatA { from{transform:translate(0,0) scale(1)} to{transform:translate(30px,50px) scale(1.15)} }
    @keyframes floatB { from{transform:translate(0,0) scale(1)} to{transform:translate(-40px,-30px) scale(1.1)} }
    @keyframes floatC { from{transform:translate(0,0)} to{transform:translate(20px,-40px)} }

    /* ===== SCREENS ===== */
    .screen {
      display: none;
      position: relative; z-index: 1;
      min-height: 100dvh;
      animation: fadeUp .35s cubic-bezier(.22,1,.36,1);
    }
    .screen.active { display: block; }
    .screen.padnav { padding-bottom: 86px; }
    @keyframes fadeUp {
      from{opacity:0;transform:translateY(16px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* ===== AUTH ===== */
    #screen-auth { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100dvh; padding:40px 28px; }
    #screen-auth.active { display:flex; }

    .auth-brand {
      display: flex; flex-direction: column; align-items: center;
      margin-bottom: 44px;
    }
    .auth-logo-mark {
      width: 72px; height: 72px;
      border-radius: 22px;
      background: linear-gradient(135deg, var(--v), var(--r));
      display: flex; align-items: center; justify-content: center;
      font-size: 34px;
      margin-bottom: 14px;
      box-shadow: 0 8px 32px rgba(124,58,237,0.35);
    }
    .auth-logo-name {
      font-family: 'ZCOOL XiaoWei', serif;
      font-size: 36px;
      background: linear-gradient(135deg, var(--vl), var(--rl));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
    }
    .auth-tagline { font-size: 13px; color: var(--t3); font-family: 'Playfair Display', serif; font-style: italic; }

    .tab-switcher {
      display: flex;
      background: var(--s2);
      border-radius: 30px;
      padding: 4px;
      margin-bottom: 24px;
      width: 100%;
    }
    .tab-btn {
      flex: 1; padding: 10px;
      border-radius: 26px; border: none; background: transparent;
      color: var(--t3); font-size: 14px;
      font-family: 'Noto Serif SC', serif;
      cursor: pointer; transition: all .25s;
    }
    .tab-btn.on { background: var(--s3); color: var(--t1); }

    .auth-form { width: 100%; display: flex; flex-direction: column; gap: 13px; }

    .fld { display: flex; flex-direction: column; gap: 6px; }
    .fld-label { font-size: 11px; color: var(--t3); letter-spacing: .07em; }
    .fld-input {
      background: var(--s2); border: 1px solid var(--b2);
      border-radius: var(--rads); padding: 13px 15px;
      color: var(--t1); font-size: 15px;
      font-family: 'Noto Serif SC', serif;
      outline: none; transition: border-color .2s, box-shadow .2s; width: 100%;
    }
    .fld-input:focus { border-color: var(--vs); box-shadow: 0 0 0 3px rgba(124,58,237,0.15); }
    .fld-input::placeholder { color: var(--t4); }

    .btn-main {
      width: 100%; padding: 15px;
      border-radius: var(--rad);
      background: linear-gradient(135deg, var(--v), var(--r));
      border: none; color: white;
      font-size: 15px; font-family: 'Noto Serif SC', serif;
      cursor: pointer; letter-spacing: .04em;
      transition: opacity .2s, transform .15s;
      position: relative; overflow: hidden; margin-top: 4px;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }
    .btn-main:active { opacity: .85; transform: scale(.98); }
    .btn-main:disabled { opacity: .45; cursor: not-allowed; }

    .divider-or { display: flex; align-items: center; gap: 10px; color: var(--t3); font-size: 12px; }
    .divider-or::before,.divider-or::after { content: ''; flex: 1; height: 1px; background: var(--b1); }

    .btn-google {
      width: 100%; padding: 13px;
      border-radius: var(--rad);
      background: var(--s2); border: 1px solid var(--b2);
      color: var(--t2); font-size: 14px;
      font-family: 'Noto Serif SC', serif;
      cursor: pointer; transition: background .2s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-google:active { background: var(--s3); }
    .google-icon { width: 20px; height: 20px; }

    .btn-ghost {
      width: 100%; padding: 13px;
      border-radius: var(--rad);
      background: transparent; border: 1px solid var(--b1);
      color: var(--t3); font-size: 13px;
      font-family: 'Noto Serif SC', serif;
      cursor: pointer; transition: background .2s;
    }
    .btn-ghost:active { background: var(--s1); }

    .emoji-picker { display: flex; gap: 10px; flex-wrap: wrap; padding: 6px 0; }
    .ep-item {
      font-size: 26px; cursor: pointer;
      transition: transform .2s, filter .2s;
      filter: grayscale(30%);
    }
    .ep-item.picked { transform: scale(1.2); filter: none drop-shadow(0 0 8px gold); }

    /* ===== ROOM ===== */
    #screen-room { display:flex; flex-direction:column; padding:60px 24px 40px; }
    #screen-room.active { display:flex; }

    .room-hero { margin-bottom: 32px; }
    .room-hero-title { font-size: 26px; line-height: 1.3; margin-bottom: 8px; }
    .room-hero-sub { font-size: 13px; color: var(--t3); line-height: 1.6; }

    .room-block {
      background: var(--s2); border: 1px solid var(--b2);
      border-radius: var(--rad); padding: 20px; margin-bottom: 12px;
    }
    .room-block-title { font-size: 14px; margin-bottom: 4px; }
    .room-block-desc { font-size: 12px; color: var(--t3); line-height: 1.5; margin-bottom: 14px; }

    .code-box {
      background: var(--bg); border-radius: var(--rads);
      padding: 16px; text-align: center;
      font-size: 30px; letter-spacing: .22em;
      font-family: 'Playfair Display', serif;
      color: var(--vs); margin-bottom: 10px;
      cursor: pointer; transition: background .2s;
      user-select: all;
    }
    .code-box:active { background: var(--s1); }
    .code-hint { font-size: 11px; color: var(--t3); text-align: center; }

    /* ===== PAGE HEADER ===== */
    .pg-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 52px 20px 16px;
    }
    .pg-title {
      font-family: 'ZCOOL XiaoWei', serif; font-size: 26px;
      background: linear-gradient(135deg, var(--vl), var(--rl));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .pg-date { font-size: 11px; color: var(--t3); margin-top: 2px; }

    .avatar-pill {
      display: flex; align-items: center; gap: 7px;
      background: var(--s2); border: 1px solid var(--b2);
      border-radius: 30px; padding: 5px 12px 5px 5px; cursor: pointer;
    }
    .av-circle {
      width: 30px; height: 30px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 15px;
    }
    .av-name { font-size: 12px; color: var(--t2); }

    /* ===== CONNECTION BAR ===== */
    .conn-bar {
      margin: 0 18px 14px;
      background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(225,29,72,0.08));
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: var(--rad); padding: 13px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .conn-avs { display: flex; }
    .conn-av {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; border: 2px solid var(--bg);
    }
    .conn-av:nth-child(2) { margin-left: -9px; }
    .conn-text { flex: 1; }
    .conn-names { font-size: 13px; }
    .conn-status { font-size: 11px; color: var(--t3); margin-top: 2px; }
    .conn-led {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--gs); box-shadow: 0 0 8px var(--gs);
      animation: led 2s ease-in-out infinite;
    }
    .conn-led.off { background: var(--t4); box-shadow: none; animation: none; }
    @keyframes led { 0%,100%{opacity:1} 50%{opacity:.35} }

    /* ===== SECTION LABEL ===== */
    .sec-lbl {
      font-size: 10px; color: var(--t3);
      letter-spacing: .14em; text-transform: uppercase;
      padding: 0 20px 9px;
    }

    /* ===== SONG CARDS ===== */
    .song-card {
      margin: 0 18px 13px;
      border-radius: var(--rad); border: 1px solid var(--b2);
      overflow: hidden; transition: transform .2s;
    }
    .song-card:active { transform: scale(.98); }

    .card-top { padding: 16px 16px 13px; position: relative; }
    .card-by {
      display: flex; align-items: center; gap: 8px; margin-bottom: 13px;
    }
    .card-av {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 13px;
    }
    .card-by-name { font-size: 12px; color: var(--t2); }
    .card-by-time { font-size: 10px; color: var(--t3); margin-left: auto; }

    .song-row { display: flex; align-items: center; gap: 13px; }
    .disc {
      width: 60px; height: 60px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 25px; flex-shrink: 0; position: relative;
    }
    .disc::after {
      content: ''; position: absolute;
      width: 13px; height: 13px; border-radius: 50%;
      background: var(--bg); top: 50%; left: 50%;
      transform: translate(-50%,-50%);
    }
    .disc.spin { animation: dspin 6s linear infinite; }
    @keyframes dspin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .disc.spin::after { animation: dspin 6s linear infinite reverse; }

    .song-info {}
    .song-name { font-size: 16px; font-weight: 600; margin-bottom: 3px; }
    .song-art { font-size: 12px; color: var(--t2); }
    .song-mood-tag {
      display: inline-flex; align-items: center; gap: 4px;
      margin-top: 7px; background: rgba(255,255,255,0.07);
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; color: var(--t2);
    }

    .card-note {
      padding: 10px 16px 14px;
      border-top: 1px solid var(--b1);
      font-size: 12px; color: var(--t2);
      line-height: 1.65; font-style: italic;
    }

    .empty-slot {
      margin: 0 18px 13px;
      border-radius: var(--rad); border: 1px dashed var(--b2);
      padding: 22px; text-align: center; cursor: pointer;
      transition: background .2s;
    }
    .empty-slot:active { background: var(--s1); }
    .empty-ico { font-size: 30px; opacity: .3; margin-bottom: 7px; }
    .empty-txt { font-size: 13px; color: var(--t3); }
    .empty-cta { font-size: 12px; color: var(--vs); margin-top: 3px; }

    /* ===== MOOD CHIPS ===== */
    .mood-row {
      display: flex; gap: 7px;
      padding: 0 18px 18px;
      overflow-x: auto; scrollbar-width: none;
    }
    .mood-row::-webkit-scrollbar { display: none; }
    .mood-chip {
      flex-shrink: 0; padding: 6px 14px;
      border-radius: 30px; border: 1px solid var(--b2);
      background: var(--s1); font-size: 12px;
      cursor: pointer; transition: all .2s; white-space: nowrap;
    }
    .mood-chip.on {
      background: linear-gradient(135deg, rgba(124,58,237,.28), rgba(225,29,72,.18));
      border-color: rgba(124,58,237,.4); color: var(--t1);
    }

    /* ===== BOTTOM NAV ===== */
    .bot-nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 430px;
      background: rgba(6,3,15,.85);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-top: 1px solid var(--b1);
      display: flex;
      padding: 9px 0 max(11px, env(safe-area-inset-bottom));
      z-index: 100;
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 3px;
      cursor: pointer; border: none; background: transparent;
      color: var(--t3); font-size: 9px;
      font-family: 'Noto Serif SC', serif;
      padding: 3px 0; transition: color .2s;
    }
    .nav-btn.on { color: var(--vs); }
    .nav-ico { font-size: 21px; line-height: 1; }
    .nav-btn.center-btn .nav-ico {
      font-size: 27px;
      background: linear-gradient(135deg, var(--vs), var(--rs));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .nav-badge {
      position: absolute; top: -2px; right: -4px;
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--rs); border: 2px solid var(--bg);
    }
    .nav-ico-wrap { position: relative; display: inline-block; }

    /* ===== POST SCREEN ===== */
    .sub-header {
      display: flex; align-items: center; gap: 13px;
      padding: 52px 20px 18px;
    }
    .icon-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--s2); border: 1px solid var(--b2);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 15px; flex-shrink: 0;
    }
    .sub-title { font-size: 19px; }

    .form-blk { margin: 0 18px 14px; }
    .form-lbl { font-size: 10px; color: var(--t3); letter-spacing: .08em; margin-bottom: 7px; display: block; }
    .form-inp {
      width: 100%; background: var(--s2); border: 1px solid var(--b2);
      border-radius: var(--rads); padding: 12px 15px;
      color: var(--t1); font-size: 14px;
      font-family: 'Noto Serif SC', serif;
      outline: none; transition: border-color .2s;
    }
    .form-inp:focus { border-color: var(--vs); }
    .form-inp::placeholder { color: var(--t4); }
    textarea.form-inp { resize: none; height: 86px; line-height: 1.6; }

    .results-box {
      margin: 0 18px 13px;
      background: var(--s1); border: 1px solid var(--b2);
      border-radius: var(--rads); overflow: hidden;
    }
    .res-row {
      display: flex; align-items: center; gap: 11px;
      padding: 10px 13px; cursor: pointer;
      border-bottom: 1px solid var(--b1); transition: background .15s;
    }
    .res-row:last-child { border-bottom: none; }
    .res-row:active { background: var(--s2); }
    .res-ico {
      width: 36px; height: 36px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; flex-shrink: 0;
    }
    .res-name { font-size: 13px; }
    .res-art { font-size: 11px; color: var(--t3); }

    .sel-box {
      margin: 0 18px 14px; background: var(--s2);
      border: 1px solid var(--b2); border-radius: var(--rads); padding: 13px 15px;
    }

    .mood-btns {
      display: flex; gap: 9px;
      padding: 0 18px 16px; overflow-x: auto; scrollbar-width: none;
    }
    .mood-btns::-webkit-scrollbar { display: none; }
    .m-btn {
      flex-shrink: 0; width: 52px; height: 52px;
      border-radius: 13px; background: var(--s2);
      border: 2px solid transparent; font-size: 24px;
      cursor: pointer; transition: all .2s;
      display: flex; align-items: center; justify-content: center;
    }
    .m-btn.on {
      border-color: var(--vs);
      background: rgba(124,58,237,.15);
      transform: scale(1.08);
    }

    /* ===== FEED ===== */
    .feed-item {
      margin: 0 18px 11px;
      background: var(--s1); border: 1px solid var(--b1);
      border-radius: var(--rad); padding: 15px;
    }
    .fi-top { display: flex; align-items: center; gap: 9px; margin-bottom: 11px; }
    .fi-av { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .fi-name { font-size: 13px; }
    .fi-time { font-size: 10px; color: var(--t3); }
    .fi-song {
      display: flex; align-items: center; gap: 11px;
      background: var(--s2); border-radius: var(--rads);
      padding: 10px; margin-bottom: 9px;
    }
    .fi-cov { width: 42px; height: 42px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 19px; flex-shrink: 0; }
    .fi-sname { font-size: 13px; font-weight: 600; }
    .fi-sart { font-size: 11px; color: var(--t3); }
    .fi-note { font-size: 12px; color: var(--t2); line-height: 1.6; margin-bottom: 9px; font-style: italic; }
    .fi-foot { display: flex; align-items: center; }
    .fi-badge { font-size: 11px; background: rgba(255,255,255,.05); padding: 3px 10px; border-radius: 20px; color: var(--t2); }
    .fi-like {
      margin-left: auto; display: flex; align-items: center; gap: 4px;
      background: none; border: none; color: var(--t3);
      font-size: 12px; cursor: pointer;
      font-family: 'Noto Serif SC', serif;
      padding: 4px 8px; border-radius: 20px; transition: all .2s;
    }
    .fi-like.liked { color: var(--rs); background: rgba(251,113,133,.08); }

    /* ===== CHAT SCREEN ===== */
    .chat-header {
      position: fixed; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 430px;
      background: rgba(6,3,15,.9); backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--b1);
      padding: 52px 20px 14px;
      z-index: 50; display: flex; align-items: center; gap: 12px;
    }
    .chat-partner-info { flex: 1; }
    .chat-partner-name { font-size: 15px; }
    .chat-partner-status { font-size: 11px; color: var(--gs); }

    .chat-messages {
      padding: 130px 16px 100px;
      display: flex; flex-direction: column; gap: 10px;
      min-height: 100dvh;
    }

    .msg-bubble {
      max-width: 75%; padding: 10px 14px;
      border-radius: 18px; font-size: 14px; line-height: 1.55;
      animation: bubbleIn .25s cubic-bezier(.22,1,.36,1);
    }
    @keyframes bubbleIn {
      from{opacity:0;transform:scale(.92) translateY(6px)}
      to{opacity:1;transform:scale(1) translateY(0)}
    }
    .msg-bubble.mine {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--v), var(--r));
      color: white;
      border-bottom-right-radius: 5px;
    }
    .msg-bubble.theirs {
      align-self: flex-start;
      background: var(--s3);
      color: var(--t1);
      border-bottom-left-radius: 5px;
    }
    .msg-time { font-size: 10px; opacity: .55; margin-top: 4px; }
    .msg-time.r { text-align: right; }

    .msg-song-card {
      max-width: 80%;
      background: var(--s2); border: 1px solid var(--b2);
      border-radius: 16px; padding: 12px;
      display: flex; align-items: center; gap: 10px;
      animation: bubbleIn .25s cubic-bezier(.22,1,.36,1);
    }
    .msg-song-card.mine { align-self: flex-end; border-bottom-right-radius: 5px; }
    .msg-song-card.theirs { align-self: flex-start; border-bottom-left-radius: 5px; }

    .chat-input-bar {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 430px;
      background: rgba(6,3,15,.9); backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--b1);
      padding: 10px 14px max(14px,env(safe-area-inset-bottom));
      display: flex; align-items: center; gap: 10px; z-index: 50;
    }
    .chat-inp {
      flex: 1; background: var(--s2); border: 1px solid var(--b2);
      border-radius: 24px; padding: 10px 16px;
      color: var(--t1); font-size: 14px;
      font-family: 'Noto Serif SC', serif;
      outline: none; transition: border-color .2s;
    }
    .chat-inp:focus { border-color: var(--vs); }
    .chat-inp::placeholder { color: var(--t4); }
    .chat-send {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, var(--v), var(--r));
      border: none; color: white; font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: transform .15s;
    }
    .chat-send:active { transform: scale(.9); }

    /* ===== HISTORY SCREEN ===== */
    .hist-month { padding: 8px 20px 6px; font-size: 11px; color: var(--t3); letter-spacing: .1em; }
    .hist-item {
      margin: 0 18px 8px;
      display: flex; align-items: center; gap: 13px;
      background: var(--s1); border: 1px solid var(--b1);
      border-radius: var(--rads); padding: 12px 14px;
      cursor: pointer; transition: background .15s;
    }
    .hist-item:active { background: var(--s2); }
    .hist-date-box {
      text-align: center; flex-shrink: 0;
      width: 38px;
    }
    .hist-day { font-size: 20px; font-family: 'Playfair Display', serif; line-height: 1; }
    .hist-mon { font-size: 10px; color: var(--t3); }
    .hist-cov { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 19px; flex-shrink: 0; }
    .hist-info { flex: 1; }
    .hist-sname { font-size: 13px; margin-bottom: 2px; }
    .hist-meta { font-size: 11px; color: var(--t3); }
    .hist-mood { font-size: 18px; }

    /* ===== PROFILE ===== */
    .prof-hero { text-align: center; padding: 58px 24px 24px; }
    .prof-ring {
      display: inline-block; padding: 3px; border-radius: 50%;
      background: linear-gradient(135deg, var(--v), var(--r));
      margin-bottom: 13px;
    }
    .prof-ring-in {
      width: 84px; height: 84px; border-radius: 50%;
      background: var(--bg2);
      display: flex; align-items: center; justify-content: center; font-size: 38px;
    }
    .prof-name { font-size: 21px; margin-bottom: 3px; }
    .prof-room { font-size: 12px; color: var(--t3); }

    .stats-row {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 1px; margin: 0 18px 18px;
      background: var(--b1); border-radius: var(--rad); overflow: hidden;
    }
    .stat-box { background: var(--s1); padding: 14px 6px; text-align: center; }
    .stat-n { font-size: 22px; font-family: 'Playfair Display', serif; }
    .stat-l { font-size: 10px; color: var(--t3); margin-top: 2px; }

    /* ===== TOAST ===== */
    .toast {
      position: fixed; top: 54px; left: 50%;
      transform: translateX(-50%) translateY(-18px);
      background: rgba(124,58,237,.92); backdrop-filter: blur(12px);
      color: white; padding: 9px 20px; border-radius: 30px;
      font-size: 13px; z-index: 9999;
      opacity: 0; transition: all .3s cubic-bezier(.22,1,.36,1);
      pointer-events: none; white-space: nowrap; max-width: 300px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ===== LOADING ===== */
    .loading {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999; transition: opacity .4s;
    }
    .loading.out { opacity: 0; pointer-events: none; }
    .ld-logo { font-family: 'ZCOOL XiaoWei', serif; font-size: 46px; background: linear-gradient(135deg, var(--vl), var(--rl)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 14px; }
    .ld-dots { display: flex; gap: 6px; }
    .ld-dot { width: 7px; height: 7px; border-radius: 50%; animation: dp 1.2s ease-in-out infinite; }
    .ld-dot:nth-child(1){background:var(--vs)}
    .ld-dot:nth-child(2){background:linear-gradient(var(--vs),var(--rs));animation-delay:.2s}
    .ld-dot:nth-child(3){background:var(--rs);animation-delay:.4s}
    @keyframes dp { 0%,100%{transform:scale(.55);opacity:.35} 50%{transform:scale(1);opacity:1} }

    .divider-line { height: 1px; background: var(--b1); margin: 4px 18px 16px; }
  </style>
</head>
<body>

<div class="glow glow-1"></div>
<div class="glow glow-2"></div>
<div class="glow glow-3"></div>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="ld-logo">åŒé¢‘</div>
  <div class="ld-dots">
    <div class="ld-dot"></div><div class="ld-dot"></div><div class="ld-dot"></div>
  </div>
</div>

<!-- AUTH -->
<div class="screen" id="screen-auth">
  <div class="auth-brand">
    <div class="auth-logo-mark">ğŸµ</div>
    <div class="auth-logo-name">åŒé¢‘</div>
    <div class="auth-tagline">A song a day, shared with you</div>
  </div>

  <div class="tab-switcher">
    <button class="tab-btn on" onclick="switchTab('login')">ç™»å½•</button>
    <button class="tab-btn" onclick="switchTab('register')">æ³¨å†Œ</button>
  </div>

  <div class="auth-form" id="form-login">
    <div class="fld">
      <label class="fld-label">é‚®ç®±</label>
      <input class="fld-input" id="li-email" type="email" placeholder="your@email.com" autocomplete="email"/>
    </div>
    <div class="fld">
      <label class="fld-label">å¯†ç </label>
      <input class="fld-input" id="li-pass" type="password" placeholder="è¾“å…¥å¯†ç " autocomplete="current-password"/>
    </div>
    <button class="btn-main" id="btn-login" onclick="doLogin()">ç™»å½•</button>
    <div class="divider-or">æˆ–è€…</div>
    <button class="btn-google" onclick="doGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      ä½¿ç”¨ Google ç™»å½•
    </button>
    <button class="btn-ghost" onclick="doGuest()">ğŸ‘¤ è®¿å®¢ä½“éªŒ</button>
  </div>

  <div class="auth-form" id="form-register" style="display:none">
    <div class="fld">
      <label class="fld-label">æ˜µç§°</label>
      <input class="fld-input" id="rg-name" type="text" placeholder="ç»™è‡ªå·±èµ·ä¸ªåå­—" maxlength="12"/>
    </div>
    <div class="fld">
      <label class="fld-label">é‚®ç®±</label>
      <input class="fld-input" id="rg-email" type="email" placeholder="your@email.com"/>
    </div>
    <div class="fld">
      <label class="fld-label">å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</label>
      <input class="fld-input" id="rg-pass" type="password" placeholder="è®¾ç½®å¯†ç "/>
    </div>
    <div class="fld">
      <label class="fld-label">é€‰ä¸€ä¸ªå¤´åƒ</label>
      <div class="emoji-picker" id="emoji-picker">
        <span class="ep-item picked" onclick="pickEmoji(this,'ğŸŒ™')">ğŸŒ™</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸŒ¸')">ğŸŒ¸</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸŒ»')">ğŸŒ»</span>
        <span class="ep-item" onclick="pickEmoji(this,'â­')">â­</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸ€')">ğŸ€</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸ”®')">ğŸ”®</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸŒŠ')">ğŸŒŠ</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸ¦‹')">ğŸ¦‹</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸ¸')">ğŸ¸</span>
        <span class="ep-item" onclick="pickEmoji(this,'ğŸŒˆ')">ğŸŒˆ</span>
      </div>
    </div>
    <button class="btn-main" id="btn-reg" onclick="doRegister()">åˆ›å»ºè´¦å·</button>
    <div class="divider-or">æˆ–è€…</div>
    <button class="btn-google" onclick="doGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      ä½¿ç”¨ Google æ³¨å†Œ
    </button>
  </div>
</div>

<!-- ROOM -->
<div class="screen" id="screen-room">
  <div class="room-hero">
    <div class="room-hero-title">åˆ›å»ºä½ ä»¬çš„<br>ä¸“å±ç©ºé—´ ğŸ”—</div>
    <div class="room-hero-sub">æ¯ä¸ªç©ºé—´æœ€å¤š2äººï¼Œé‚€è¯·æœ€æƒ³åŒé¢‘çš„é‚£ä¸ªäºº</div>
  </div>
  <div class="room-block">
    <div class="room-block-title">åˆ›å»ºæ–°ç©ºé—´</div>
    <div class="room-block-desc">ç”Ÿæˆé‚€è¯·ç å‘ç»™å¯¹æ–¹ï¼Œç­‰TAåŠ å…¥</div>
    <div class="code-box" id="code-box" onclick="copyCode()">â€”â€”</div>
    <div class="code-hint">ç‚¹å‡»å¤åˆ¶é‚€è¯·ç </div>
    <div style="height:12px"></div>
    <button class="btn-main" id="btn-create" onclick="createRoom()">ç”Ÿæˆé‚€è¯·ç </button>
  </div>
  <div class="room-block">
    <div class="room-block-title">åŠ å…¥å·²æœ‰ç©ºé—´</div>
    <div class="room-block-desc">è¾“å…¥å¯¹æ–¹çš„é‚€è¯·ç åŠ å…¥TAçš„ç©ºé—´</div>
    <input class="fld-input" id="join-inp" type="text" placeholder="è¾“å…¥6ä½é‚€è¯·ç " maxlength="6"
      style="text-transform:uppercase;letter-spacing:.18em;font-size:18px;text-align:center;margin-bottom:12px"/>
    <button class="btn-main" id="btn-join" onclick="joinRoom()">åŠ å…¥ç©ºé—´</button>
  </div>
  <button class="btn-ghost" onclick="doSignOut()">é€€å‡ºç™»å½•</button>
</div>

<!-- HOME -->
<div class="screen padnav" id="screen-home">
  <div class="pg-header">
    <div>
      <div class="pg-title">åŒé¢‘</div>
      <div class="pg-date" id="home-date"></div>
    </div>
    <div class="avatar-pill" onclick="navigate('profile')">
      <div class="av-circle" id="home-av" style="background:rgba(124,58,237,.2)">ğŸŒ™</div>
      <div class="av-name" id="home-uname">æˆ‘</div>
    </div>
  </div>

  <div class="conn-bar" id="conn-bar">
    <div class="conn-avs">
      <div class="conn-av" id="cb-me" style="background:rgba(124,58,237,.25)">ğŸŒ™</div>
      <div class="conn-av" id="cb-partner" style="background:rgba(225,29,72,.2)">ğŸ‘¤</div>
    </div>
    <div class="conn-text">
      <div class="conn-names" id="cb-names">ç­‰å¾…å¯¹æ–¹åŠ å…¥...</div>
      <div class="conn-status" id="cb-status">è¿˜æ²¡æœ‰ä¼™ä¼´è¿æ¥</div>
    </div>
    <div class="conn-led off" id="conn-led"></div>
  </div>

  <div class="sec-lbl">æˆ‘ä»Šæ—¥åˆ†äº«</div>
  <div id="my-today">
    <div class="empty-slot" onclick="navigate('post')">
      <div class="empty-ico">ğŸµ</div>
      <div class="empty-txt">ä»Šå¤©è¿˜æ²¡æœ‰åˆ†äº«</div>
      <div class="empty-cta">ç‚¹å‡»åˆ†äº«ä»Šæ—¥ä¹‹æ­Œ â†’</div>
    </div>
  </div>

  <div class="sec-lbl">TA ä»Šæ—¥åˆ†äº«</div>
  <div id="partner-today">
    <div class="empty-slot">
      <div class="empty-ico">â³</div>
      <div class="empty-txt">ç­‰å¾…å¯¹æ–¹ä»Šæ—¥åˆ†äº«...</div>
    </div>
  </div>

  <div class="sec-lbl">ä»Šæ—¥å¿ƒæƒ…</div>
  <div class="mood-row" id="home-moods"></div>
</div>

<!-- POST -->
<div class="screen padnav" id="screen-post">
  <div class="sub-header">
    <button class="icon-btn" onclick="navigate('home')">â†</button>
    <div class="sub-title">åˆ†äº«ä»Šæ—¥ä¹‹æ­Œ ğŸ¶</div>
  </div>
  <div class="form-blk">
    <label class="form-lbl">æœç´¢æ­Œæ›²</label>
    <input class="form-inp" id="song-search" type="text" placeholder="æœç´¢æ­Œåã€æ­Œæ‰‹..." oninput="doSearch(this.value)"/>
  </div>
  <div id="search-res"></div>
  <div class="form-blk">
    <label class="form-lbl">å·²é€‰æ­Œæ›²</label>
    <div id="sel-song" class="sel-box" style="color:var(--t3);font-size:13px">è¿˜æ²¡é€‰æ­Œå“¦ â™ª</div>
  </div>
  <div class="form-blk"><label class="form-lbl">ä»Šæ—¥å¿ƒæƒ…</label></div>
  <div class="mood-btns" id="post-moods"></div>
  <div class="form-blk">
    <label class="form-lbl">æƒ³è¯´çš„è¯ï¼ˆå¯é€‰ï¼‰</label>
    <textarea class="form-inp" id="post-note" placeholder="ä»Šå¤©æ˜¯ä»€ä¹ˆè®©ä½ æƒ³èµ·äº†è¿™é¦–æ­Œ..."></textarea>
  </div>
  <div style="margin:0 18px 30px">
    <button class="btn-main" onclick="submitPost()">åˆ†äº«ç»™TA ğŸ’Œ</button>
  </div>
</div>

<!-- FEED -->
<div class="screen padnav" id="screen-feed">
  <div class="pg-header">
    <div><div class="pg-title">å…±é¸£</div><div class="pg-date">ä½ ä»¬å…±åŒçš„ä¹å•</div></div>
  </div>
  <div id="feed-list"><div style="text-align:center;color:var(--t3);padding:40px;font-size:13px">åŠ è½½ä¸­...</div></div>
</div>

<!-- CHAT -->
<div class="screen" id="screen-chat">
  <div class="chat-header">
    <button class="icon-btn" onclick="navigate('home')">â†</button>
    <div class="chat-partner-info">
      <div class="chat-partner-name" id="chat-partner-name">TA</div>
      <div class="chat-partner-status" id="chat-status">åœ¨çº¿</div>
    </div>
  </div>
  <div class="chat-messages" id="chat-msgs">
    <div style="text-align:center;color:var(--t3);font-size:12px;padding:20px">å¼€å§‹èŠå¤©å§ ğŸ’¬</div>
  </div>
  <div class="chat-input-bar">
    <input class="chat-inp" id="chat-inp" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeydown="if(event.key==='Enter')sendMsg()"/>
    <button class="chat-send" onclick="sendMsg()">â†‘</button>
  </div>
</div>

<!-- HISTORY -->
<div class="screen padnav" id="screen-history">
  <div class="pg-header">
    <div><div class="pg-title">å›å¿†</div><div class="pg-date">æ¯ä¸€å¤©çš„æ•…äº‹</div></div>
  </div>
  <div id="hist-list"><div style="text-align:center;color:var(--t3);padding:40px;font-size:13px">è¿˜æ²¡æœ‰è®°å½•</div></div>
</div>

<!-- PROFILE -->
<div class="screen padnav" id="screen-profile">
  <div class="prof-hero">
    <div class="prof-ring"><div class="prof-ring-in" id="prof-emoji">ğŸŒ™</div></div>
    <div class="prof-name" id="prof-name">ç”¨æˆ·å</div>
    <div class="prof-room" id="prof-room">æˆ¿é—´ç ï¼šâ€”â€”</div>
  </div>
  <div class="stats-row">
    <div class="stat-box"><div class="stat-n" id="ps-songs">0</div><div class="stat-l">åˆ†äº«æ­Œæ›²</div></div>
    <div class="stat-box"><div class="stat-n" id="ps-days">0</div><div class="stat-l">å…±åŒå¤©æ•°</div></div>
    <div class="stat-box"><div class="stat-n" id="ps-streak">0</div><div class="stat-l">è¿ç»­æ‰“å¡</div></div>
  </div>
  <div class="sec-lbl">æœ€è¿‘åˆ†äº«</div>
  <div id="prof-hist"></div>
  <div style="margin:18px;display:flex;gap:10px">
    <button class="btn-main" style="flex:1;padding:12px;font-size:13px" onclick="copyInvite()">ğŸ”— é‚€è¯·å¥½å‹</button>
    <button class="btn-ghost" style="width:50px;padding:12px" onclick="doSignOut()">â†©</button>
  </div>
</div>

<!-- BOT NAV -->
<nav class="bot-nav" id="bot-nav" style="display:none">
  <button class="nav-btn on" id="nav-home" onclick="navigate('home')">
    <span class="nav-ico">ğŸ </span><span>ä¸»é¡µ</span>
  </button>
  <button class="nav-btn" id="nav-feed" onclick="navigate('feed')">
    <span class="nav-ico">ğŸ’</span><span>å…±é¸£</span>
  </button>
  <button class="nav-btn center-btn" id="nav-post" onclick="navigate('post')">
    <span class="nav-ico">ï¼‹</span><span>åˆ†äº«</span>
  </button>
  <button class="nav-btn" id="nav-chat" onclick="navigate('chat')">
    <span class="nav-ico-wrap"><span class="nav-ico">ğŸ’¬</span><span class="nav-badge" id="chat-badge" style="display:none"></span></span>
    <span>èŠå¤©</span>
  </button>
  <button class="nav-btn" id="nav-history" onclick="navigate('history')">
    <span class="nav-ico">ğŸ“…</span><span>å›å¿†</span>
  </button>
</nav>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, orderBy, onSnapshot, updateDoc, arrayUnion, arrayRemove, increment, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeUsfrvAa0ABvibU0vcecraYKB9gAWka4",
authDomain: "tongpin.firebaseapp.com",
projectId: "tongpin",
storageBucket: "tongpin.firebasestorage.app",
messagingSenderId: "328815005862",
appId: "1:328815005862:web:a29605cf754557553fa467"
};

const configured = true;
window._cfg = configured;

if (!configured) {
  hideLoading();
  initDemo();
} else {
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  window._auth = auth;
  window._db = db;
  window._fb = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, GoogleAuthProvider, signInWithPopup, updateProfile, signOut, doc, setDoc, getDoc, addDoc, collection, query, orderBy, onSnapshot, updateDoc, arrayUnion, arrayRemove, increment, serverTimestamp, limit };

  onAuthStateChanged(auth, async user => {
    hideLoading();
    if (user) {
      await loadMe(user);
    } else {
      showScreen('auth'); hideNav();
    }
  });
}

window.loadMe = async function(user) {
  try {
    const snap = await window._fb.getDoc(window._fb.doc(window._db,'users',user.uid));
    window._me = snap.exists() ? {uid:user.uid,...snap.data()} : {uid:user.uid,name:user.displayName||'ç”¨æˆ·',emoji:'ğŸŒ™',roomId:null};
    if (window._me.roomId) enterRoom(window._me.roomId);
    else { showScreen('room'); hideNav(); }
  } catch(e) { showScreen('auth'); hideNav(); }
};

window.enterRoom = function(roomId) {
  window._rid = roomId;
  showScreen('home'); showNav();
  updateHomeUI();
  listenRoom(roomId);
  listenFeed(roomId);
  listenChat(roomId);
};

window.listenRoom = function(rid) {
  const {doc,onSnapshot,getDoc} = window._fb, db=window._db;
  onSnapshot(doc(db,'rooms',rid), async snap => {
    if(!snap.exists()) return;
    const members = snap.data().members||[];
    const pid = members.find(id=>id!==window._me.uid);
    if(pid) {
      const ps = await getDoc(doc(db,'users',pid));
      if(ps.exists()) { window._partner={uid:pid,...ps.data()}; updateConnBar(true); loadPartnerToday(); }
    } else { window._partner=null; updateConnBar(false); }
  });
};

window.listenFeed = function(rid) {
  const {collection,query,orderBy,onSnapshot,limit} = window._fb, db=window._db;
  const q = query(collection(db,'rooms',rid,'posts'),orderBy('createdAt','desc'),limit(60));
  onSnapshot(q, snap => {
    window._posts = snap.docs.map(d=>({id:d.id,...d.data()}));
    if(window._cur==='feed') renderFeed();
    updateProfStats();
    if(window._cur==='history') renderHistory();
  });
};

window.listenChat = function(rid) {
  const {collection,query,orderBy,onSnapshot} = window._fb, db=window._db;
  const q = query(collection(db,'rooms',rid,'chat'),orderBy('at','asc'));
  onSnapshot(q, snap => {
    window._msgs = snap.docs.map(d=>({id:d.id,...d.data()}));
    if(window._cur==='chat') renderChat();
    else {
      const unread = window._msgs.filter(m=>m.uid!==window._me?.uid && !m.read);
      document.getElementById('chat-badge').style.display = unread.length>0?'block':'none';
    }
  });
};

window.loadPartnerToday = async function() {
  if(!window._partner) return;
  const today = td();
  const snap = await window._fb.getDoc(window._fb.doc(window._db,'rooms',window._rid,'daily',`${window._partner.uid}_${today}`));
  if(snap.exists()) renderPartnerCard(snap.data());
};

window.doGoogle = async function() {
  if(!window._auth) return toast('æ¼”ç¤ºæ¨¡å¼ä¸æ”¯æŒ Google ç™»å½•');
  try {
    const provider = new window._fb.GoogleAuthProvider();
    const cred = await window._fb.signInWithPopup(window._auth, provider);
    const user = cred.user;
    const snap = await window._fb.getDoc(window._fb.doc(window._db,'users',user.uid));
    if(!snap.exists()) {
      await window._fb.setDoc(window._fb.doc(window._db,'users',user.uid),{
        name: user.displayName||'Googleç”¨æˆ·', emoji:'ğŸŒ™', email:user.email, createdAt:window._fb.serverTimestamp()
      });
    }
  } catch(e) { toast('Google ç™»å½•å¤±è´¥ï¼š'+e.message); }
};
</script>

<script>
// ===== SONG DATABASE (100+ songs) =====
const SONGS = [
  // å‘¨æ°ä¼¦
  {n:'æ™´å¤©',a:'å‘¨æ°ä¼¦',e:'ğŸŒ¤',c:'#fbbf24'},{n:'ç¨»é¦™',a:'å‘¨æ°ä¼¦',e:'ğŸŒ¾',c:'#86efac'},
  {n:'å¤œæ›²',a:'å‘¨æ°ä¼¦',e:'ğŸŒ™',c:'#818cf8'},{n:'ä¸ƒé‡Œé¦™',a:'å‘¨æ°ä¼¦',e:'ğŸŒ¿',c:'#34d399'},
  {n:'å‘Šç™½æ°”çƒ',a:'å‘¨æ°ä¼¦',e:'ğŸˆ',c:'#fb7185'},{n:'çˆ±åœ¨è¥¿å…ƒå‰',a:'å‘¨æ°ä¼¦',e:'ğŸ›',c:'#fde68a'},
  {n:'é’èŠ±ç“·',a:'å‘¨æ°ä¼¦',e:'ğŸº',c:'#93c5fd'},{n:'çƒŸèŠ±æ˜“å†·',a:'å‘¨æ°ä¼¦',e:'ğŸ†',c:'#c4b5fd'},
  {n:'è¯´å¥½ä¸å“­',a:'å‘¨æ°ä¼¦',e:'ğŸ˜¢',c:'#60a5fa'},{n:'ä¸èƒ½è¯´çš„ç§˜å¯†',a:'å‘¨æ°ä¼¦',e:'ğŸ¤«',c:'#a78bfa'},
  {n:'å½©è™¹',a:'å‘¨æ°ä¼¦',e:'ğŸŒˆ',c:'#f9a8d4'},{n:'ç®€å•çˆ±',a:'å‘¨æ°ä¼¦',e:'ğŸ’•',c:'#fda4af'},
  // åè¯­
  {n:'å¹³å‡¡ä¹‹è·¯',a:'æœ´æ ‘',e:'ğŸ›¤',c:'#a78bfa'},{n:'å—å±±å—',a:'é©¬é ”',e:'ğŸ”',c:'#60a5fa'},
  {n:'æˆéƒ½',a:'èµµé›·',e:'ğŸ™',c:'#f59e0b'},{n:'æˆ‘è®°å¾—',a:'èµµé›·',e:'ğŸ’­',c:'#c084fc'},
  {n:'åæ¥',a:'åˆ˜è‹¥è‹±',e:'ğŸ•¯',c:'#fdba74'},{n:'çº¢è±†',a:'ç‹è²',e:'â¤ï¸',c:'#ef4444'},
  {n:'æµ·é˜”å¤©ç©º',a:'Beyond',e:'ğŸŒŠ',c:'#38bdf8'},{n:'æµ®å¤¸',a:'é™ˆå¥•è¿…',e:'âœ¨',c:'#e879f9'},
  {n:'æ¼ æ²³èˆå…',a:'æŸ³çˆ½',e:'ğŸ•º',c:'#93c5fd'},{n:'æ¶ˆæ„',a:'æ¯›ä¸æ˜“',e:'ğŸº',c:'#d4a373'},
  {n:'èµ·é£äº†',a:'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸',e:'ğŸƒ',c:'#86efac'},{n:'ç›—å°†è¡Œ',a:'èŠ±ç²¥',e:'ğŸŒº',c:'#f9a8d4'},
  {n:'éœ“è™¹ç”œå¿ƒ',a:'å‘Šäº”äºº',e:'ğŸ’œ',c:'#c084fc'},{n:'ä½“é¢',a:'äºæ–‡æ–‡',e:'ğŸŒˆ',c:'#6ee7b7'},
  {n:'æˆ‘æ›¾',a:'éš”å£è€æ¨Š',e:'ğŸ¸',c:'#fbbf24'},{n:'å¯æƒœæ²¡å¦‚æœ',a:'æ—ä¿Šæ°',e:'ğŸ‚',c:'#f97316'},
  {n:'ä¿®ç‚¼çˆ±æƒ…',a:'æ—ä¿Šæ°',e:'ğŸŒ¹',c:'#f43f5e'},{n:'ä¸ä¸ºè°è€Œä½œçš„æ­Œ',a:'æ—ä¿Šæ°',e:'ğŸµ',c:'#a78bfa'},
  {n:'æ±Ÿå—',a:'æ—ä¿Šæ°',e:'ğŸŒ¿',c:'#34d399'},{n:'æ›¹æ“',a:'æ—ä¿Šæ°',e:'âš”ï¸',c:'#fbbf24'},
  {n:'çˆ±æˆ‘åˆ«èµ°',a:'å¼ éœ‡å²³',e:'ğŸƒ',c:'#fb923c'},{n:'æ€å¿µæ˜¯ä¸€ç§ç—…',a:'å¼ éœ‡å²³',e:'ğŸ¤’',c:'#818cf8'},
  {n:'æ–°ä¸äº†æƒ…',a:'ä¸‡èŠ³',e:'ğŸ’Œ',c:'#fda4af'},{n:'é¢†æ‚Ÿ',a:'è¾›æ™“çª',e:'ğŸ’¡',c:'#fbbf24'},
  {n:'é‡è§',a:'è§äºšè½©',e:'ğŸŒŸ',c:'#fde68a'},{n:'çˆ±æƒ…è½¬ç§»',a:'é™ˆå¥•è¿…',e:'ğŸ”„',c:'#93c5fd'},
  {n:'åå¹´',a:'é™ˆå¥•è¿…',e:'ğŸ—“',c:'#c084fc'},{n:'å¯Œå£«å±±ä¸‹',a:'é™ˆå¥•è¿…',e:'ğŸ—»',c:'#e0f2fe'},
  {n:'ç™½æœˆå…‰ä¸æœ±ç ‚ç—£',a:'å¤§ç‹',e:'ğŸŒ•',c:'#fde68a'},{n:'æ¸…ç©º',a:'å¼ ç¢§æ™¨',e:'ğŸ«§',c:'#bfdbfe'},
  {n:'å¯èƒ½å¦',a:'é¹¿å…ˆæ£®ä¹é˜Ÿ',e:'ğŸ¦Œ',c:'#bbf7d0'},{n:'å®‰å’Œæ¡¥',a:'å®‹å†¬é‡',e:'ğŸŒ‰',c:'#818cf8'},
  {n:'è‘£å°å§',a:'å®‹å†¬é‡',e:'ğŸ‘’',c:'#fdba74'},{n:'æ–‘é©¬æ–‘é©¬',a:'å®‹å†¬é‡',e:'ğŸ¦“',c:'#e5e7eb'},
  {n:'ç†æƒ³ä¸‰æ—¬',a:'é™ˆé¸¿å®‡',e:'ğŸ·',c:'#9f1239'},{n:'æ¹–å¿ƒ',a:'é™ˆé¸¿å®‡',e:'ğŸŒŠ',c:'#0ea5e9'},
  {n:'è¿½å…‰è€…',a:'å²‘å®å„¿',e:'ğŸ’¡',c:'#fde68a'},{n:'å­˜åœ¨',a:'æ±ªå³°',e:'ğŸŒ…',c:'#fb923c'},
  {n:'åƒæˆ‘è¿™æ ·çš„äºº',a:'æ¯›ä¸æ˜“',e:'ğŸš¶',c:'#a78bfa'},{n:'å…¥æµ·',a:'é¹¿æ™—',e:'ğŸŒŠ',c:'#38bdf8'},
  {n:'å…‰å¹´ä¹‹å¤–',a:'G.E.M.',e:'â­',c:'#fde68a'},{n:'æ³¡æ²«',a:'G.E.M.',e:'ğŸ«§',c:'#bfdbfe'},
  // æ—¥éŸ©
  {n:'èŠ±ã¯å’²ã',a:'èŠ±ã¯å’²ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',e:'ğŸŒ¸',c:'#fda4af'},{n:'å¤œã«é§†ã‘ã‚‹',a:'YOASOBI',e:'ğŸŒ™',c:'#818cf8'},
  {n:'ã‚¢ã‚¤ãƒ‰ãƒ«',a:'YOASOBI',e:'â­',c:'#fde68a'},{n:'Dynamite',a:'BTS',e:'ğŸ’¥',c:'#fbbf24'},
  {n:'Love Scenario',a:'iKON',e:'ğŸ’',c:'#fda4af'},
  // æ¬§ç¾
  {n:'Shape of You',a:'Ed Sheeran',e:'ğŸ’ƒ',c:'#f9a8d4'},{n:'Perfect',a:'Ed Sheeran',e:'ğŸ’‘',c:'#fda4af'},
  {n:'Blinding Lights',a:'The Weeknd',e:'ğŸ’¡',c:'#fca5a5'},{n:'Starboy',a:'The Weeknd',e:'â­',c:'#fde68a'},
  {n:'Lover',a:'Taylor Swift',e:'ğŸ’—',c:'#f9a8d4'},{n:'Love Story',a:'Taylor Swift',e:'ğŸ“–',c:'#fde68a'},
  {n:'Someone Like You',a:'Adele',e:'ğŸŒ§',c:'#93c5fd'},{n:'Hello',a:'Adele',e:'ğŸ“',c:'#818cf8'},
  {n:'Let Her Go',a:'Passenger',e:'ğŸš‚',c:'#fed7aa'},{n:'Counting Stars',a:'OneRepublic',e:'â­',c:'#fde68a'},
  {n:'Demons',a:'Imagine Dragons',e:'ğŸ‘¹',c:'#dc2626'},{n:'Believer',a:'Imagine Dragons',e:'ğŸ’ª',c:'#f97316'},
  {n:'Happier',a:'Marshmello',e:'ğŸ˜Š',c:'#fbbf24'},{n:'Faded',a:'Alan Walker',e:'ğŸŒ«',c:'#93c5fd'},
  {n:'Alone',a:'Alan Walker',e:'ğŸš¶',c:'#818cf8'},{n:'Stay',a:'Justin Bieber',e:'ğŸ™',c:'#a78bfa'},
  {n:'Peaches',a:'Justin Bieber',e:'ğŸ‘',c:'#fb923c'},{n:'positions',a:'Ariana Grande',e:'ğŸ’œ',c:'#c084fc'},
  {n:'thank u, next',a:'Ariana Grande',e:'ğŸ’‹',c:'#fda4af'},{n:'Bad Guy',a:'Billie Eilish',e:'ğŸ˜ˆ',c:'#4ade80'},
  {n:'Ocean Eyes',a:'Billie Eilish',e:'ğŸŒŠ',c:'#38bdf8'},{n:'Sunflower',a:'Post Malone',e:'ğŸŒ»',c:'#fbbf24'},
  {n:'Circles',a:'Post Malone',e:'â­•',c:'#a78bfa'},{n:'Levitating',a:'Dua Lipa',e:'âœ¨',c:'#c084fc'},
  {n:'New Rules',a:'Dua Lipa',e:'ğŸ“',c:'#38bdf8'},
];

const MOODS = [
  {e:'ğŸŒ¸',t:'å¹³é™'},{e:'ğŸŒ¤',t:'æ„‰æ‚¦'},{e:'ğŸŒ™',t:'æ€å¿µ'},{e:'ğŸ”¥',t:'å…´å¥‹'},
  {e:'ğŸŒ§',t:'ä½è½'},{e:'ğŸ’«',t:'æ„ŸåŠ¨'},{e:'ğŸŒˆ',t:'æ²»æ„ˆ'},{e:'â˜•',t:'æ…µæ‡’'},
  {e:'ğŸ’ª',t:'å…ƒæ°”'},{e:'ğŸŒŠ',t:'è‡ªç”±'},{e:'ğŸ­',t:'å¤æ‚'},{e:'ğŸ‚',t:'ä¼¤æ„Ÿ'}
];

// STATE
window._me = null;
window._partner = null;
window._rid = null;
window._posts = [];
window._msgs = [];
window._cur = 'loading';
window._selSong = null;
window._selMood = MOODS[1];
window._selEmoji = 'ğŸŒ™';

// DEMO MODE
function initDemo() {
  window._me = {uid:'demo',name:'æ¼”ç¤ºç”¨æˆ·',emoji:'ğŸŒ™',roomId:'demo'};
  window._partner = {uid:'p',name:'å°å¤ªé˜³',emoji:'ğŸŒ»'};
  window._rid = 'demo';
  window._posts = [
    {id:'1',userId:'p',userName:'å°å¤ªé˜³',userEmoji:'ğŸŒ»',song:{n:'æ™´å¤©',a:'å‘¨æ°ä¼¦',e:'ğŸŒ¤',c:'#fbbf24'},mood:{e:'â˜€ï¸',t:'æ„‰æ‚¦'},note:'ä»Šå¤©å¤©æ°”çœŸå¥½~',likes:3,likedBy:[],createdAt:{toDate:()=>new Date()}},
    {id:'2',userId:'demo',userName:'æ¼”ç¤ºç”¨æˆ·',userEmoji:'ğŸŒ™',song:{n:'å—å±±å—',a:'é©¬é ”',e:'ğŸ”',c:'#60a5fa'},mood:{e:'ğŸŒ™',t:'æ€å¿µ'},note:'æœ‰äº›äººæ€»ä¼šçªç„¶æƒ³èµ·',likes:5,likedBy:['demo'],createdAt:{toDate:()=>new Date(Date.now()-86400000)}},
    {id:'3',userId:'p',userName:'å°å¤ªé˜³',userEmoji:'ğŸŒ»',song:{n:'èµ·é£äº†',a:'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸',e:'ğŸƒ',c:'#86efac'},mood:{e:'ğŸŒ¸',t:'å¹³é™'},note:'',likes:2,likedBy:[],createdAt:{toDate:()=>new Date(Date.now()-172800000)}},
  ];
  window._msgs = [
    {id:'m1',uid:'p',name:'å°å¤ªé˜³',text:'ä»Šå¤©ä½ å¬äº†ä»€ä¹ˆæ­Œï¼Ÿ',at:{toDate:()=>new Date(Date.now()-3600000)}},
    {id:'m2',uid:'demo',name:'æ¼”ç¤ºç”¨æˆ·',text:'å—å±±å—ï¼Œä½ å‘¢ï¼Ÿ',at:{toDate:()=>new Date(Date.now()-3000000)}},
    {id:'m3',uid:'p',name:'å°å¤ªé˜³',text:'æˆ‘åœ¨å¬æ™´å¤© ğŸŒ¤ å¥½æ²»æ„ˆ',at:{toDate:()=>new Date(Date.now()-1800000)}},
  ];
  showScreen('home'); showNav(); updateHomeUI(); updateConnBar(true);
  renderPartnerCard({song:{n:'æ™´å¤©',a:'å‘¨æ°ä¼¦',e:'ğŸŒ¤',c:'#fbbf24'},mood:{e:'â˜€ï¸',t:'æ„‰æ‚¦'},note:'ä»Šå¤©å¤©æ°”çœŸå¥½~',userName:'å°å¤ªé˜³',userEmoji:'ğŸŒ»'});
  toast('æ¼”ç¤ºæ¨¡å¼ Â· é…ç½® Firebase åå¯çœŸå®ä½¿ç”¨');
}

// UTILS
function td() { return new Date().toISOString().slice(0,10); }
function ago(d) {
  if(!d) return '';
  const dt = d.toDate?d.toDate():new Date(d);
  const diff = Date.now()-dt.getTime();
  if(diff<60000) return 'åˆšåˆš';
  if(diff<3600000) return Math.floor(diff/60000)+'åˆ†é’Ÿå‰';
  if(diff<86400000) return `ä»Šå¤© ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
  if(diff<172800000) return 'æ˜¨å¤©';
  return `${dt.getMonth()+1}/${dt.getDate()}`;
}

function toast(msg,dur=2500) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}
function hideLoading() {
  const l=document.getElementById('loading');
  l.classList.add('out');
  setTimeout(()=>l.style.display='none',400);
}
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  window._cur=name;
}
function showNav(){document.getElementById('bot-nav').style.display='flex';}
function hideNav(){document.getElementById('bot-nav').style.display='none';}

window.navigate = function(name) {
  showScreen(name);
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('on'));
  const nb=document.getElementById('nav-'+name);
  if(nb) nb.classList.add('on');
  if(name==='feed') renderFeed();
  if(name==='profile') renderProfile();
  if(name==='chat') { renderChat(); document.getElementById('chat-badge').style.display='none'; }
  if(name==='history') renderHistory();
};

// AUTH
window.switchTab = function(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('on',(i===0)===(tab==='login')));
  document.getElementById('form-login').style.display=tab==='login'?'flex':'none';
  document.getElementById('form-register').style.display=tab==='register'?'flex':'none';
};

window.pickEmoji = function(el,emoji) {
  document.querySelectorAll('.ep-item').forEach(e=>e.classList.remove('picked'));
  el.classList.add('picked');
  window._selEmoji=emoji;
};

window.doLogin = async function() {
  if(!window._auth) return toast('è¯·å…ˆé…ç½® Firebase');
  const email=document.getElementById('li-email').value.trim();
  const pass=document.getElementById('li-pass').value;
  if(!email||!pass) return toast('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
  const btn=document.getElementById('btn-login');
  btn.disabled=true; btn.textContent='ç™»å½•ä¸­...';
  try {
    await window._fb.signInWithEmailAndPassword(window._auth,email,pass);
  } catch(e) {
    toast(e.code==='auth/wrong-password'?'å¯†ç é”™è¯¯':e.code==='auth/user-not-found'?'ç”¨æˆ·ä¸å­˜åœ¨':'ç™»å½•å¤±è´¥');
    btn.disabled=false; btn.textContent='ç™»å½•';
  }
};

window.doRegister = async function() {
  if(!window._auth) return toast('è¯·å…ˆé…ç½® Firebase');
  const name=document.getElementById('rg-name').value.trim();
  const email=document.getElementById('rg-email').value.trim();
  const pass=document.getElementById('rg-pass').value;
  if(!name||!email||!pass) return toast('è¯·å¡«å†™æ‰€æœ‰ä¿¡æ¯');
  if(pass.length<6) return toast('å¯†ç è‡³å°‘6ä½');
  const btn=document.getElementById('btn-reg');
  btn.disabled=true; btn.textContent='åˆ›å»ºä¸­...';
  try {
    const cred=await window._fb.createUserWithEmailAndPassword(window._auth,email,pass);
    await window._fb.updateProfile(cred.user,{displayName:name});
    await window._fb.setDoc(window._fb.doc(window._db,'users',cred.user.uid),{
      name,emoji:window._selEmoji,email,createdAt:window._fb.serverTimestamp()
    });
  } catch(e) {
    toast(e.code==='auth/email-already-in-use'?'é‚®ç®±å·²æ³¨å†Œ':'æ³¨å†Œå¤±è´¥');
    btn.disabled=false; btn.textContent='åˆ›å»ºè´¦å·';
  }
};

window.doGuest = async function() {
  if(!window._auth) return initDemo();
  try {
    const cred=await window._fb.signInAnonymously(window._auth);
    await window._fb.setDoc(window._fb.doc(window._db,'users',cred.user.uid),{
      name:'åŒ¿åæ—…äºº',emoji:'ğŸŒ™',createdAt:window._fb.serverTimestamp()
    });
  } catch(e){ toast('è®¿å®¢ç™»å½•å¤±è´¥'); }
};

window.doSignOut = async function() {
  if(window._auth) await window._fb.signOut(window._auth);
  window._me=null; window._partner=null; window._rid=null;
  showScreen('auth'); hideNav();
};

// ROOM
window.createRoom = async function() {
  if(!window._db) return toast('æ¼”ç¤ºæ¨¡å¼ä¸æ”¯æŒæ­¤æ“ä½œ');
  const code=Math.random().toString(36).slice(2,8).toUpperCase();
  const btn=document.getElementById('btn-create');
  btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­...';
  try {
    const {doc,setDoc,updateDoc,serverTimestamp}=window._fb, db=window._db;
    await setDoc(doc(db,'rooms',code),{code,members:[window._me.uid],createdAt:serverTimestamp()});
    await updateDoc(doc(db,'users',window._me.uid),{roomId:code});
    window._me.roomId=code;
    document.getElementById('code-box').textContent=code;
    toast('é‚€è¯·ç å·²ç”Ÿæˆï¼å¤åˆ¶å‘ç»™TA ğŸ’Œ');
    btn.disabled=false; btn.textContent='ç”Ÿæˆé‚€è¯·ç ';
    window._rid=code;
    setTimeout(()=>enterRoom(code),800);
  } catch(e){ toast('åˆ›å»ºå¤±è´¥'); btn.disabled=false; btn.textContent='ç”Ÿæˆé‚€è¯·ç '; }
};

window.joinRoom = async function() {
  if(!window._db) return toast('æ¼”ç¤ºæ¨¡å¼ä¸æ”¯æŒæ­¤æ“ä½œ');
  const code=document.getElementById('join-inp').value.trim().toUpperCase();
  if(code.length!==6) return toast('è¯·è¾“å…¥6ä½é‚€è¯·ç ');
  const btn=document.getElementById('btn-join');
  btn.disabled=true; btn.textContent='åŠ å…¥ä¸­...';
  try {
    const {doc,getDoc,updateDoc}=window._fb, db=window._db;
    const snap=await getDoc(doc(db,'rooms',code));
    if(!snap.exists()){ toast('æˆ¿é—´ä¸å­˜åœ¨'); btn.disabled=false; btn.textContent='åŠ å…¥ç©ºé—´'; return; }
    const members=snap.data().members||[];
    if(members.length>=2&&!members.includes(window._me.uid)){ toast('ç©ºé—´å·²æ»¡'); btn.disabled=false; btn.textContent='åŠ å…¥ç©ºé—´'; return; }
    await updateDoc(doc(db,'rooms',code),{members:[...new Set([...members,window._me.uid])]});
    await updateDoc(doc(db,'users',window._me.uid),{roomId:code});
    window._me.roomId=code;
    toast('åŠ å…¥æˆåŠŸï¼');
    enterRoom(code);
  } catch(e){ toast('åŠ å…¥å¤±è´¥ï¼š'+e.message); btn.disabled=false; btn.textContent='åŠ å…¥ç©ºé—´'; }
};

window.copyCode = function() {
  const c=document.getElementById('code-box').textContent;
  if(c==='â€”â€”') return toast('è¯·å…ˆåˆ›å»ºç©ºé—´');
  navigator.clipboard?.writeText(c).then(()=>toast('é‚€è¯·ç å·²å¤åˆ¶ ğŸ’Œ'));
};
window.copyInvite = function() {
  const c=window._rid||window._me?.roomId;
  if(!c) return toast('è¿˜æ²¡æœ‰åŠ å…¥ç©ºé—´');
  navigator.clipboard?.writeText(c).then(()=>toast('é‚€è¯·ç å·²å¤åˆ¶ï¼'));
};

// HOME
function updateHomeUI() {
  if(!window._me) return;
  const d=new Date();
  const days=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
  document.getElementById('home-date').textContent=`${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${days[d.getDay()]}`;
  document.getElementById('home-av').textContent=window._me.emoji||'ğŸŒ™';
  document.getElementById('home-uname').textContent=window._me.name||'æˆ‘';
  document.getElementById('cb-me').textContent=window._me.emoji||'ğŸŒ™';
  renderMoodChips();
  loadMyToday();
}

function renderMoodChips() {
  const c=document.getElementById('home-moods');
  c.innerHTML=MOODS.map((m,i)=>`<div class="mood-chip${i===1?' on':''}">${m.e} ${m.t}</div>`).join('');
  c.querySelectorAll('.mood-chip').forEach(ch=>ch.addEventListener('click',function(){
    c.querySelectorAll('.mood-chip').forEach(x=>x.classList.remove('on'));
    this.classList.add('on');
  }));
}

async function loadMyToday() {
  if(!window._me||!window._rid||!window._db) return;
  const snap=await window._fb.getDoc(window._fb.doc(window._db,'rooms',window._rid,'daily',`${window._me.uid}_${td()}`));
  if(snap.exists()) renderMyCard(snap.data());
}

function renderMyCard(d) {
  const {song,mood,note}=d;
  document.getElementById('my-today').innerHTML=`
    <div class="song-card">
      <div class="card-top" style="background:linear-gradient(135deg,${song.c}1a,${song.c}0d)">
        <div class="card-by">
          <div class="card-av" style="background:${song.c}33">${window._me?.emoji||'ğŸŒ™'}</div>
          <div class="card-by-name">${window._me?.name||'æˆ‘'}</div>
          <div class="card-by-time">ä»Šå¤©</div>
        </div>
        <div class="song-row">
          <div class="disc spin" style="background:radial-gradient(circle,${song.c}99,${song.c}44)">${song.e}</div>
          <div><div class="song-name">${song.n}</div><div class="song-art">${song.a}</div><div class="song-mood-tag">${mood.e} ${mood.t}</div></div>
        </div>
      </div>
      ${note?`<div class="card-note">"${note}"</div>`:''}
    </div>`;
}

function renderPartnerCard(d) {
  const {song,mood,note,userName,userEmoji}=d;
  document.getElementById('partner-today').innerHTML=`
    <div class="song-card">
      <div class="card-top" style="background:linear-gradient(135deg,${song.c}1a,${song.c}0d)">
        <div class="card-by">
          <div class="card-av" style="background:${song.c}33">${userEmoji||window._partner?.emoji||'ğŸŒ»'}</div>
          <div class="card-by-name">${userName||window._partner?.name||'TA'}</div>
          <div class="card-by-time">ä»Šå¤©</div>
        </div>
        <div class="song-row">
          <div class="disc" style="background:radial-gradient(circle,${song.c}99,${song.c}44)">${song.e}</div>
          <div><div class="song-name">${song.n}</div><div class="song-art">${song.a}</div><div class="song-mood-tag">${mood.e} ${mood.t}</div></div>
        </div>
      </div>
      ${note?`<div class="card-note">"${note}"</div>`:''}
    </div>`;
}

function updateConnBar(on) {
  if(!window._partner) return;
  document.getElementById('cb-partner').textContent=window._partner.emoji||'ğŸ‘¤';
  document.getElementById('cb-names').textContent=`${window._me?.name||'æˆ‘'} & ${window._partner.name}`;
  document.getElementById('cb-status').textContent=on?'å·²è¿æ¥ Â· å®æ—¶åŒæ­¥':'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
  document.getElementById('chat-partner-name').textContent=window._partner.name||'TA';
  document.getElementById('conn-led').classList.toggle('off',!on);
}

// POST
window.doSearch = function(val) {
  const c=document.getElementById('search-res');
  if(!val.trim()){c.innerHTML='';return;}
  const res=SONGS.filter(s=>s.n.includes(val)||s.a.includes(val)||s.n.toLowerCase().includes(val.toLowerCase())||s.a.toLowerCase().includes(val.toLowerCase())).slice(0,7);
  if(!res.length){c.innerHTML=`<div style="text-align:center;color:var(--t3);padding:14px;font-size:12px">æ²¡æ‰¾åˆ°"${val}"</div>`;return;}
  c.innerHTML=`<div class="results-box">`+res.map(s=>`<div class="res-row" onclick='pickSong(${JSON.stringify(s)})'><div class="res-ico" style="background:linear-gradient(135deg,${s.c}99,${s.c}44)">${s.e}</div><div><div class="res-name">${s.n}</div><div class="res-art">${s.a}</div></div></div>`).join('')+'</div>';
};

window.pickSong = function(song) {
  window._selSong=song;
  document.getElementById('search-res').innerHTML='';
  document.getElementById('song-search').value='';
  document.getElementById('sel-song').innerHTML=`<div style="display:flex;align-items:center;gap:11px"><div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,${song.c}99,${song.c}44);display:flex;align-items:center;justify-content:center;font-size:21px">${song.e}</div><div><div style="font-size:14px">${song.n}</div><div style="font-size:11px;color:var(--t3)">${song.a}</div></div></div>`;
  toast(`å·²é€‰ã€Š${song.n}ã€‹`);
};

function renderMoodBtns() {
  document.getElementById('post-moods').innerHTML=MOODS.map((m,i)=>`<button class="m-btn${i===1?' on':''}" onclick="pickMood(this,'${m.e}','${m.t}')">${m.e}</button>`).join('');
}

window.pickMood = function(el,e,t) {
  document.querySelectorAll('.m-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  window._selMood={e,t};
};

window.submitPost = async function() {
  if(!window._selSong) return toast('è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œ ğŸµ');
  const note=document.getElementById('post-note').value.trim();
  const data={
    userId:window._me.uid, userName:window._me.name, userEmoji:window._me.emoji,
    song:window._selSong, mood:window._selMood, note,
    createdAt:window._db?window._fb.serverTimestamp():new Date().toISOString(),
    likes:0, likedBy:[]
  };
  try {
    if(window._db) {
      const {doc,setDoc,addDoc,collection}=window._fb,db=window._db;
      await setDoc(doc(db,'rooms',window._rid,'daily',`${window._me.uid}_${td()}`),data);
      await addDoc(collection(db,'rooms',window._rid,'posts'),data);
    } else {
      window._posts.unshift({id:Date.now()+'', ...data, createdAt:{toDate:()=>new Date()}});
    }
    renderMyCard(data);
    toast('åˆ†äº«æˆåŠŸï¼ğŸ’Œ');
    document.getElementById('post-note').value='';
    window._selSong=null;
    document.getElementById('sel-song').innerHTML='è¿˜æ²¡é€‰æ­Œå“¦ â™ª';
    document.getElementById('sel-song').style.color='var(--t3)';
    navigate('home');
  } catch(e){ toast('å‘å¸ƒå¤±è´¥ï¼š'+e.message); }
};

// FEED
function renderFeed() {
  const list=document.getElementById('feed-list');
  if(!window._posts?.length){list.innerHTML='<div style="text-align:center;color:var(--t3);padding:40px;font-size:13px">è¿˜æ²¡æœ‰åˆ†äº«è®°å½•<br>å¿«å»åˆ†äº«ç¬¬ä¸€é¦–æ­Œå§ ğŸµ</div>';return;}
  list.innerHTML=window._posts.map((p,i)=>{
    const liked=p.likedBy?.includes(window._me?.uid);
    return `<div class="feed-item" style="animation-delay:${i*.04}s">
      <div class="fi-top">
        <div class="fi-av" style="background:${p.song?.c||'#888'}33">${p.userEmoji||'ğŸµ'}</div>
        <div><div class="fi-name">${p.userName||'ç”¨æˆ·'}</div><div class="fi-time">${ago(p.createdAt)}</div></div>
      </div>
      <div class="fi-song">
        <div class="fi-cov" style="background:linear-gradient(135deg,${p.song?.c||'#888'}88,${p.song?.c||'#888'}44)">${p.song?.e||'ğŸµ'}</div>
        <div><div class="fi-sname">${p.song?.n||'æœªçŸ¥'}</div><div class="fi-sart">${p.song?.a||''}</div></div>
      </div>
      ${p.note?`<div class="fi-note">"${p.note}"</div>`:''}
      <div class="fi-foot">
        <div class="fi-badge">${p.mood?.e||''} ${p.mood?.t||''}</div>
        <button class="fi-like${liked?' liked':''}" onclick="doLike('${p.id}',${liked})">${liked?'â¤ï¸':'ğŸ¤'} ${p.likes||0}</button>
      </div>
    </div>`;
  }).join('');
}

window.doLike = async function(pid,liked) {
  const p=window._posts.find(x=>x.id===pid); if(!p) return;
  const nl=!liked;
  p.likes=(p.likes||0)+(nl?1:-1);
  if(nl) p.likedBy=[...(p.likedBy||[]),window._me.uid];
  else p.likedBy=(p.likedBy||[]).filter(id=>id!==window._me.uid);
  renderFeed();
  if(window._db){
    const {doc,updateDoc,arrayUnion,arrayRemove,increment}=window._fb;
    await updateDoc(window._fb.doc(window._db,'rooms',window._rid,'posts',pid),{
      likes:increment(nl?1:-1),
      likedBy:nl?arrayUnion(window._me.uid):arrayRemove(window._me.uid)
    }).catch(()=>{});
  }
};

// CHAT
function renderChat() {
  if(!window._partner) {
    document.getElementById('chat-msgs').innerHTML='<div style="text-align:center;color:var(--t3);padding:60px 20px;font-size:13px">è¿˜æ²¡æœ‰ä¼™ä¼´ï¼Œå…ˆå»é‚€è¯·TAå§ ğŸ”—</div>';
    return;
  }
  const msgs=window._msgs||[];
  document.getElementById('chat-msgs').innerHTML=msgs.length?msgs.map(m=>{
    const mine=m.uid===window._me?.uid;
    return `<div class="msg-bubble ${mine?'mine':'theirs'}">${m.text}<div class="msg-time${mine?' r':''}">${ago(m.at)}</div></div>`;
  }).join(''):'<div style="text-align:center;color:var(--t3);font-size:12px;padding:30px">å¼€å§‹èŠå¤©å§ ğŸ’¬</div>';
  setTimeout(()=>{const c=document.getElementById('chat-msgs');c.scrollTop=c.scrollHeight;},100);
}

window.sendMsg = async function() {
  const inp=document.getElementById('chat-inp');
  const text=inp.value.trim(); if(!text) return;
  inp.value='';
  const msg={uid:window._me.uid,name:window._me.name,text,at:new Date().toISOString(),read:false};
  if(window._db){
    const {addDoc,collection,serverTimestamp}=window._fb;
    await addDoc(window._fb.collection(window._db,'rooms',window._rid,'chat'),{...msg,at:serverTimestamp()}).catch(()=>{});
  } else {
    window._msgs.push({id:Date.now()+'', ...msg, at:{toDate:()=>new Date()}});
    renderChat();
  }
};

// HISTORY
function renderHistory() {
  const list=document.getElementById('hist-list');
  const myPosts=(window._posts||[]).filter(p=>p.userId===window._me?.uid);
  if(!myPosts.length){list.innerHTML='<div style="text-align:center;color:var(--t3);padding:40px;font-size:13px">è¿˜æ²¡æœ‰åˆ†äº«è®°å½•<br>å¿«å»åˆ†äº«ç¬¬ä¸€é¦–æ­Œå§ ğŸµ</div>';return;}
  list.innerHTML=myPosts.map(p=>{
    const d=p.createdAt?.toDate?p.createdAt.toDate():new Date();
    return `<div class="hist-item">
      <div class="hist-date-box"><div class="hist-day">${d.getDate()}</div><div class="hist-mon">${d.getMonth()+1}æœˆ</div></div>
      <div class="hist-cov" style="background:linear-gradient(135deg,${p.song?.c||'#888'}88,${p.song?.c||'#888'}44)">${p.song?.e||'ğŸµ'}</div>
      <div class="hist-info"><div class="hist-sname">${p.song?.n||'æœªçŸ¥'}</div><div class="hist-meta">${p.song?.a||''} Â· ${p.mood?.t||''}</div></div>
      <div class="hist-mood">${p.mood?.e||''}</div>
    </div>`;
  }).join('');
}

// PROFILE
function renderProfile() {
  if(!window._me) return;
  document.getElementById('prof-emoji').textContent=window._me.emoji||'ğŸŒ™';
  document.getElementById('prof-name').textContent=window._me.name||'ç”¨æˆ·';
  document.getElementById('prof-room').textContent=`æˆ¿é—´ç ï¼š${window._rid||'â€”'}`;
  updateProfStats();
  const myPosts=(window._posts||[]).filter(p=>p.userId===window._me?.uid);
  document.getElementById('prof-hist').innerHTML=myPosts.slice(0,8).map(p=>`
    <div class="hist-item">
      <div class="hist-cov" style="background:linear-gradient(135deg,${p.song?.c||'#888'}88,${p.song?.c||'#888'}44)">${p.song?.e||'ğŸµ'}</div>
      <div class="hist-info"><div class="hist-sname">${p.song?.n||'æœªçŸ¥'}</div><div class="hist-meta">${p.song?.a||''} Â· ${ago(p.createdAt)}</div></div>
      <div class="hist-mood">${p.mood?.e||''}</div>
    </div>`).join('')||'<div style="text-align:center;color:var(--t3);padding:20px;font-size:12px">è¿˜æ²¡æœ‰åˆ†äº«è®°å½•</div>';
}

function updateProfStats() {
  const myPosts=(window._posts||[]).filter(p=>p.userId===window._me?.uid);
  document.getElementById('ps-songs').textContent=myPosts.length;
  const days=new Set(myPosts.map(p=>{const d=p.createdAt?.toDate?.();return d?d.toISOString().slice(0,10):td();}));
  document.getElementById('ps-days').textContent=days.size;
  document.getElementById('ps-streak').textContent=Math.min(myPosts.length,99);
}

// INIT
renderMoodBtns();
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
if(!window._cfg) setTimeout(hideLoading,300);
</script>
</body>
</html>
